
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafetyLab | Dr. Yuan-Wei Wu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Space+Grotesk:wght@300;500;700&family=Noto+Serif+TC:wght@500;700&display=swap" rel="stylesheet">
    <style>
        html {
            font-size: 18px;
            scroll-behavior: smooth;
            scroll-padding-top: 80px; 
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FDFCF8;
            color: #1C1917;
            overflow-x: hidden;
        }
        h1, h2, h3, .font-heading {
            font-family: 'Space Grotesk', sans-serif;
        }
        .font-serif-tc {
            font-family: 'Noto Serif TC', serif;
        }
        canvas {
            touch-action: none;
        }
        ::selection {
            background: #FFEDD5;
            color: #9A3412;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.8s ease-out forwards;
        }
        .delay-1 { animation-delay: 0.2s; }
        .delay-2 { animation-delay: 0.4s; }
        
        ::-webkit-scrollbar {
            width: 4px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #E7E5E4;
            border-radius: 10px;
        }
    </style>
    <script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@^1.34.0",
    "react": "https://esm.sh/react@^19.2.3",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body class="selection:bg-orange-100 selection:text-orange-900">
    <!-- Dummy root to prevent mounting errors -->
    <div id="root" style="display:none"></div>

    <nav class="fixed top-0 left-0 w-full z-50 px-6 py-2.5 md:px-12 flex justify-between items-center bg-white/80 backdrop-blur-xl border-b border-orange-50/50">
        <div class="flex flex-col">
            <div class="text-base font-bold tracking-tighter uppercase font-heading text-stone-900">
                Safety<span class="text-amber-700">Lab</span>
            </div>
            <div class="text-[8px] font-bold tracking-[0.4em] text-stone-400 uppercase">
                Yuan-Wei Wu
            </div>
        </div>
        <div class="hidden md:flex gap-6 text-[10px] font-bold uppercase tracking-widest text-stone-500">
            <a href="#research-interests" class="hover:text-amber-700 transition-colors">INTERESTS</a>
            <a href="#research-projects" class="hover:text-amber-700 transition-colors">PROJECTS</a>
            <a href="#publications" class="hover:text-amber-700 transition-colors">PUBLICATIONS</a>
        </div>
    </nav>

    <main class="relative z-10 pt-12">
        <section id="hero" class="relative px-6 md:px-24 pt-16 pb-16 overflow-hidden min-h-[70vh] flex items-center bg-white">
            <canvas id="hero-canvas" class="absolute inset-0 z-0 pointer-events-none opacity-80"></canvas>
            
            <div class="max-w-6xl relative z-10 w-full pointer-events-auto">
                <div class="mb-4 opacity-0 animate-fade-in">
                    <div class="inline-block px-3 py-0.5 bg-orange-50 text-orange-800 text-[9px] font-bold uppercase tracking-[0.4em] mb-2 rounded-full border border-orange-100">
                        Assistant Professor
                    </div>
                    <h1 class="text-5xl md:text-7xl font-bold tracking-tight text-stone-900 font-heading leading-[1.05] mb-2">
                        吳元維 <br />
                        <span class="text-amber-800/80 font-light text-2xl md:text-4xl tracking-tight">Yuan-Wei Wu</span>
                    </h1>
                    <div class="flex flex-col border-l-4 border-amber-500 pl-4">
                        <p class="text-stone-800 text-sm font-medium tracking-wide">中央警察大學 交通學系</p>
                        <p class="text-stone-400 text-[10px] font-light uppercase tracking-wider">Department of Traffic Science, Central Police University</p>
                    </div>
                </div>
                <h2 class="text-lg md:text-2xl font-bold leading-tight mb-4 tracking-tighter text-stone-300 opacity-0 animate-fade-in delay-1 uppercase">
                    Engineering <span class="text-stone-900">Empirical</span> <br />
                    Accountability in <span class="text-amber-700">Traffic</span>
                </h2>
                <p class="text-base text-stone-500 max-w-lg leading-relaxed opacity-0 animate-fade-in delay-2">
                    透過 <span class="text-amber-900 font-semibold border-b border-amber-50">AI</span> 與 <span class="text-amber-900 font-semibold border-b border-amber-50">資料科學</span>，重構交通安全分析的精準度。
                </p>
            </div>
        </section>

        <div style="font-size: 1.1rem;">
            <section id="about" class="relative bg-stone-50/50 py-16 px-6 md:px-24 border-y border-stone-100/60">
                <div class="max-w-6xl mx-auto">
                    <div class="space-y-6 max-w-2xl">
                        <div class="group">
                            <p class="text-lg font-bold text-stone-900">中央警察大學 交通學系</p>
                            <p class="text-base text-stone-500">助理教授</p>
                        </div>
                        <div class="pt-4 border-t border-stone-200 group">
                            <p class="text-lg font-bold text-stone-900">國立臺灣大學 土木工程學系 博士</p>
                            <p class="text-base text-stone-500 italic">Ph.D., Civil Engineering, NTU</p>
                        </div>
                        <div class="pt-2 flex flex-wrap gap-x-6 gap-y-3" id="expertise-container"></div>
                    </div>
                </div>
            </section>

            <section id="research-interests" class="relative py-16 px-6 md:px-24 bg-white">
                <div class="max-w-5xl mx-auto">
                    <h2 class="text-3xl font-bold text-stone-950 font-heading mb-10 border-b-2 border-amber-50 inline-block">Research Interest <span class="text-stone-300 ml-3">研究興趣</span></h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="interests-container"></div>
                </div>
            </section>

            <section id="research-projects" class="relative py-16 px-6 md:px-24 bg-stone-50/30">
                <div class="max-w-5xl mx-auto">
                    <h2 class="text-3xl font-bold font-heading mb-10 text-stone-900 border-b-2 border-stone-200 inline-block">Research Projects <span class="text-stone-300 ml-3">研究計畫</span></h2>
                    <div class="space-y-4" id="projects-container"></div>
                </div>
            </section>

            <section id="publications" class="relative py-16 px-6 md:px-24 bg-white">
                <div class="max-w-5xl mx-auto">
                    <div class="mb-16">
                        <h2 class="text-3xl font-bold text-stone-950 font-heading mb-10 border-l-4 border-amber-600 pl-4">Journal Papers <span class="text-stone-200 ml-3">期刊論文</span></h2>
                        <div class="space-y-10" id="journals-container"></div>
                    </div>
                    <div class="pt-12 border-t border-stone-100">
                        <h2 class="text-2xl font-bold text-stone-950 font-heading mb-10">Conference Papers <span class="text-stone-300 ml-3">研討會論文</span></h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-10" id="conferences-container"></div>
                    </div>
                </div>
            </section>

            <section id="service" class="relative py-20 px-6 md:px-24 bg-stone-50/60">
                <div class="max-w-6xl mx-auto">
                    <h2 class="text-3xl font-bold text-stone-950 font-heading mb-12 text-center">Academic Service <span class="text-stone-300 ml-3">學術服務</span></h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="bg-white p-8 rounded-3xl border border-stone-200/50 shadow-sm flex flex-col h-full hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
                            <h3 class="text-lg font-bold text-stone-900 mb-6 pb-2 border-b border-stone-50">Journal Review 審查</h3>
                            <ul class="space-y-3 flex-1" id="service-journals"></ul>
                        </div>
                        <div class="bg-white p-8 rounded-3xl border border-stone-200/50 shadow-sm flex flex-col h-full hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
                            <h3 class="text-lg font-bold text-stone-900 mb-6 pb-2 border-b border-stone-50">Administration 行政</h3>
                            <ul class="space-y-3 flex-1" id="service-university"></ul>
                        </div>
                        <div class="bg-white p-8 rounded-3xl border border-stone-200/50 shadow-sm flex flex-col h-full hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
                            <h3 class="text-lg font-bold text-stone-900 mb-6 pb-2 border-b border-stone-50">Advisory 政府</h3>
                            <ul class="space-y-3 flex-1" id="service-government"></ul>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Updated Footer: Changed from black (stone-900) to deep stone-200/50 for a unified theme -->
            <footer id="contact" class="relative py-16 px-6 md:px-24 bg-stone-200/50 border-t border-stone-300/60 text-stone-800">
                <div class="max-w-6xl mx-auto">
                    <div class="flex flex-col md:flex-row justify-between items-start gap-12 mb-12">
                        <div>
                            <h3 class="text-3xl font-bold mb-4 font-heading text-stone-900">吳元維 <span class="text-stone-500 font-light text-xl ml-2">Yuan-Wei Wu</span></h3>
                            <p class="text-sm text-stone-500 mb-8">中央警察大學 交通學系助理教授</p>
                            <a href="mailto:grantwyw@mail.cpu.edu.tw" class="text-2xl font-bold text-amber-700 hover:text-amber-800 transition-all underline decoration-stone-300 underline-offset-8">
                                grantwyw@mail.cpu.edu.tw
                            </a>
                        </div>
                    </div>
                    <div class="pt-8 border-t border-stone-300 flex flex-col md:flex-row justify-between items-center text-stone-400 text-[11px] uppercase tracking-[0.4em]">
                        <span>© 2025 Dr. Yuan-Wei Wu | 中央警察大學交通學系</span>
                    </div>
                </div>
            </footer>
        </div>
    </main>

    <div class="fixed bottom-10 right-10 z-50">
        <div id="chat-window" class="hidden w-80 h-[32rem] bg-white border border-orange-100 rounded-3xl flex-col shadow-2xl overflow-hidden">
            <div class="p-5 border-b border-orange-50 flex justify-between items-center bg-orange-50/20">
                <span class="text-[11px] font-bold uppercase tracking-[0.2em] text-amber-900">AI Associate</span>
                <button onclick="toggleChat(false)" class="text-stone-400 hover:text-amber-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                </button>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-5 space-y-5"></div>
            <div class="p-5 bg-white border-t border-stone-100">
                <div class="relative">
                    <input id="chat-input" type="text" placeholder="Ask me anything..." class="w-full bg-stone-50 border border-stone-200 rounded-2xl pl-5 pr-12 py-3.5 text-sm focus:outline-none focus:ring-2 focus:ring-amber-200 focus:bg-white transition-all">
                    <button id="send-btn" class="absolute right-3 top-3 text-amber-600 hover:text-amber-800 transition-colors p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                    </button>
                </div>
            </div>
        </div>
        <button id="chat-toggle" onclick="toggleChat(true)" class="w-16 h-16 bg-amber-700 text-white rounded-full shadow-lg flex items-center justify-center hover:scale-110 active:scale-95 transition-all duration-300">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" /></svg>
        </button>
    </div>

    <script type="module">
        import { GoogleGenAI } from "@google/genai";

        // --- Data ---
        const EXPERTISE = ["Traffic Policing 交通警察實務", "Road Safety & Crash Investigation 交通安全與事故調查", "AI & Data Science 應用人工智慧與資料科學", "Transportation Engineering 運輸工程", "Mathematical Planning 數學規劃"];
        const RESEARCH_INTERESTS = ["交通執法成效分析", "交通衝突之在地化探討", "交通事故調查與重建技術", "交通安全政策與專業能力發展"];
        const RESEARCH_PROJECTS = [
            { title: "Integration of Advanced Measurement Techniques, 3D Modeling, and an Evidence Recognition Model for Traffic Crash Scene Reconstruction", org: "國家科學及技術委員會", period: "2025.08 ~ 2026.07" },
            { title: "區域運輸發展研究中心服務升級 3.0 計畫 - 北區區域道安計畫", role: "協同主持人", org: "交通部運輸研究所", period: "民國 114 年迄今" },
            { title: "道安專業人力培訓暨知識平台策略內容研析", org: "交通部運輸研究所", period: "民國 114 年迄今" },
            { title: "道安改善專業能力建構", org: "交通部運輸研究所", period: "民國 113 年" },
            { title: "道路交通安全資料整合與分析平台建置學術研究", org: "交通部", period: "民國 108 年" }
        ];
        const PUBLICATIONS = [
            { year: '2024', journal: '交通學報', title: '道路交通安全從業人員專業培訓需求分析之初探', authors: '吳元維*、楊馥榕', link: 'https://ts.cpu.edu.tw/p/406-1020-44159,r647.php' },
            { year: '2023', journal: '交通學報', title: '基於多元線性回歸模型及可解釋機器學習模型之精準執法成效分析', authors: '盧冠仁、吳元維*', link: 'https://ts.cpu.edu.tw/p/406-1020-42081,r647.php' },
            { year: '2022', journal: 'Accident Analysis and Prevention (SSCI)', title: 'Temporal stability of associations between crash characteristics: A multiple correspondence analysis.', authors: 'Hsu, T.P., Wu, Y.W.*, Chen, A.Y.', link: 'https://www.sciencedirect.com/science/article/abs/pii/S0001457522000264' },
            { year: '2021', journal: 'Accident Analysis and Prevention (SSCI)', title: 'Mid-term prediction of at-fault crash driver frequency using fusion deep learning with city-level traffic violation data.', authors: 'Wu, Y.W.*, Hsu, T.P.', link: 'https://www.sciencedirect.com/science/article/abs/pii/S0001457520317309' }
        ];
        const CONFERENCES = [
            { year: '2025', event: '道路交通安全與執法研討會', title: '應用遙測技術於交通事故現場重建之探討', authors: '游薛武、吳元維*、李旻晃、潘啟文' },
            { year: '2024', event: '道路交通安全與執法研討會', title: '道路交通安全從業人員專業培訓需求分析之初探', authors: '吳元維*、周文生、楊馥榕、曾群明' },
            { year: '2023', event: '道路交通安全與執法研討會', title: '基於多元線性回歸模型及可解釋機器學習模型之精準執法成效分析', authors: '盧冠仁、吳元維*' },
            { year: '2019', event: '13th EASTS Conference', title: 'Mining characteristics of speeding and red light running violations.', authors: 'Wu, Y.W.*, Hsu, T.P.' }
        ];
        const SERVICE = {
            journals: ["Accident Analysis and Prevention (SSCI)", "Engineering Application of Artificial Intelligence (SCI)", "Scientific Reports (SCI)"],
            university: ["鑑識科學委員會委員 (2025 迄今)", "交通學報編輯委員 (2025 迄今)", "智慧科技執法研究中心執行秘書 (2025 迄今)", "警察科技學院 助理教授 (2024 ~ 2025)"],
            government: ["桃園市政府交通局交通維持計畫審查委員 (2025 迄今)"]
        };

        const SYSTEM_PROMPT = `You are the AI Research Associate for Dr. Yuan-Wei, Wu, an Assistant Professor at Central Police University. Be academic and precise.`;

        // --- Render UI ---
        function renderUI() {
            const safeSet = (id, html) => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = html;
            };

            safeSet('expertise-container', EXPERTISE.map(item => `
                <div class="flex items-center gap-2 text-sm text-stone-600"><div class="w-1.5 h-1.5 bg-amber-600 rounded-full"></div>${item}</div>
            `).join(''));

            safeSet('interests-container', RESEARCH_INTERESTS.map((interest, idx) => `
                <div class="flex items-center gap-4 p-5 bg-stone-50/50 border border-stone-100 rounded-xl hover:border-amber-300 transition-all hover:bg-white shadow-sm">
                    <span class="w-10 h-10 flex items-center justify-center bg-white border border-stone-100 rounded-lg text-amber-700 font-mono text-sm font-bold">0${idx + 1}</span>
                    <span class="text-base font-bold text-stone-800">${interest}</span>
                </div>
            `).join(''));

            safeSet('projects-container', RESEARCH_PROJECTS.map(p => `
                <div class="flex flex-col md:flex-row md:items-center gap-4 border-b border-stone-100 pb-4 p-4 rounded-xl hover:bg-white transition-all">
                    <span class="md:w-32 text-[12px] font-mono text-stone-400 font-bold uppercase shrink-0">${p.period}</span>
                    <div class="flex-1">
                        <h3 class="text-base font-bold text-stone-800 leading-snug">${p.title}</h3>
                        <div class="flex gap-4 text-[11px] uppercase text-stone-400 mt-1"><span class="text-amber-600 font-semibold">${p.org}</span>${p.role ? `<span>| ${p.role}</span>` : ''}</div>
                    </div>
                </div>
            `).join(''));

            safeSet('journals-container', PUBLICATIONS.map(pub => `
                <div class="py-4 border-b border-stone-50 last:border-0 group">
                    <div class="flex gap-3 items-center mb-1">
                        <span class="px-2 py-0.5 bg-orange-100 text-orange-800 text-[10px] font-bold rounded-full">${pub.year}</span>
                        <span class="text-[11px] font-bold text-stone-400 uppercase tracking-widest">${pub.journal}</span>
                    </div>
                    <a href="${pub.link || '#'}" target="_blank" class="hover:text-amber-800 transition-colors"><h5 class="text-xl font-bold text-stone-900 leading-snug mb-1">${pub.title}</h5></a>
                    <p class="text-sm text-stone-500 font-medium">${pub.authors}</p>
                </div>
            `).join(''));

            safeSet('conferences-container', CONFERENCES.map(conf => `
                <div class="border-l-2 border-stone-100 pl-6 pb-2 hover:border-amber-300 transition-colors">
                    <span class="text-[11px] font-bold text-amber-600 uppercase">${conf.year}</span>
                    <h5 class="text-base font-bold text-stone-800 leading-snug mb-1">${conf.title}</h5>
                    <p class="text-[11px] text-stone-500 italic font-medium">${conf.authors}</p>
                </div>
            `).join(''));

            const sList = (items) => items.map(item => `<li class="text-[13px] text-stone-600 flex items-start gap-3"><span class="text-amber-500 mt-1.5 shrink-0"><svg class="w-2 h-2" fill="currentColor" viewBox="0 0 8 8"><circle cx="4" cy="4" r="3"/></svg></span>${item}</li>`).join('');
            safeSet('service-journals', sList(SERVICE.journals));
            safeSet('service-university', sList(SERVICE.university));
            safeSet('service-government', sList(SERVICE.government));
        }

        // --- Optimized Canvas Animation ---
        function initCanvas() {
            const canvas = document.getElementById('hero-canvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            let particles = [];
            const mouse = { x: -2000, y: -2000, radius: 280 };

            function resize() {
                const section = document.getElementById('hero');
                canvas.width = section.clientWidth;
                canvas.height = section.clientHeight;
                initParticles();
            }

            function initParticles() {
                particles = [];
                const count = Math.floor((canvas.width * canvas.height) / 10000);
                for (let i = 0; i < Math.min(count, 120); i++) {
                    particles.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height,
                        vx: (Math.random() - 0.5) * 0.4,
                        vy: (Math.random() - 0.5) * 0.4,
                        baseVx: (Math.random() - 0.5) * 0.3,
                        baseVy: (Math.random() - 0.5) * 0.3,
                        size: Math.random() * 2 + 0.5
                    });
                }
            }

            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                const rect = canvas.getBoundingClientRect();
                const mx = mouse.x - rect.left;
                const my = mouse.y - rect.top;

                particles.forEach((p, i) => {
                    const dx = p.x - mx;
                    const dy = p.y - my;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    if (dist < mouse.radius) {
                        const force = (mouse.radius - dist) / mouse.radius;
                        const angle = Math.atan2(dy, dx);
                        p.vx -= Math.cos(angle) * force * 0.5;
                        p.vy -= Math.sin(angle) * force * 0.5;
                        
                        ctx.beginPath();
                        ctx.strokeStyle = `rgba(217, 119, 6, ${(1 - dist / mouse.radius) * 0.15})`;
                        ctx.lineWidth = 0.5;
                        ctx.moveTo(p.x, p.y); ctx.lineTo(mx, my); ctx.stroke();
                    } else {
                        p.vx += (p.baseVx - p.vx) * 0.03;
                        p.vy += (p.baseVy - p.vy) * 0.03;
                    }

                    p.x += p.vx; p.y += p.vy;
                    p.vx *= 0.99; p.vy *= 0.99;

                    if (p.x < 0) p.x = canvas.width; if (p.x > canvas.width) p.x = 0;
                    if (p.y < 0) p.y = canvas.height; if (p.y > canvas.height) p.y = 0;

                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    ctx.fillStyle = dist < mouse.radius ? `rgba(180, 83, 9, 0.5)` : `rgba(120, 113, 108, 0.15)`;
                    ctx.fill();

                    for (let j = i + 1; j < particles.length; j++) {
                        const p2 = particles[j];
                        const d = Math.sqrt((p.x - p2.x)**2 + (p.y - p2.y)**2);
                        if (d < 160) {
                            ctx.beginPath();
                            ctx.strokeStyle = `rgba(120, 113, 108, ${(1 - d / 160) * 0.1})`;
                            ctx.lineWidth = 0.3;
                            ctx.moveTo(p.x, p.y); ctx.lineTo(p2.x, p2.y); ctx.stroke();
                        }
                    }
                });
                requestAnimationFrame(draw);
            }

            window.addEventListener('resize', resize);
            window.addEventListener('mousemove', (e) => { 
                mouse.x = e.clientX; 
                mouse.y = e.clientY; 
            });
            resize(); draw();
        }

        window.toggleChat = (open) => {
            document.getElementById('chat-window').style.display = open ? 'flex' : 'none';
            document.getElementById('chat-toggle').style.display = open ? 'none' : 'flex';
        };

        document.addEventListener('DOMContentLoaded', () => {
            renderUI();
            initCanvas();
            
            try {
                const getApiKey = () => {
                    try { return typeof process !== 'undefined' ? process.env.API_KEY : ''; } catch { return ''; }
                };
                const key = getApiKey();
                const ai = key ? new GoogleGenAI({ apiKey: key }) : null;

                const handleSend = async () => {
                    const input = document.getElementById('chat-input');
                    const messages = document.getElementById('chat-messages');
                    const text = input.value.trim();
                    if (!text || !ai) return;

                    const uBox = document.createElement('div');
                    uBox.className = 'flex justify-end';
                    uBox.innerHTML = `<div class="bg-amber-700 text-white p-3 rounded-2xl text-[13px] font-medium max-w-[85%] shadow-sm">${text}</div>`;
                    messages.appendChild(uBox);
                    input.value = '';
                    messages.scrollTop = messages.scrollHeight;

                    const lBox = document.createElement('div');
                    lBox.className = 'flex justify-start';
                    lBox.innerHTML = `<div class="bg-stone-50 p-3 rounded-2xl border border-stone-100 text-[13px] text-stone-400">Thinking...</div>`;
                    messages.appendChild(lBox);

                    try {
                        const res = await ai.models.generateContent({
                            model: 'gemini-3-flash-preview',
                            contents: text,
                            config: { systemInstruction: SYSTEM_PROMPT, temperature: 0.7, maxOutputTokens: 200 }
                        });
                        lBox.remove();
                        const aBox = document.createElement('div');
                        aBox.className = 'flex justify-start';
                        aBox.innerHTML = `<div class="bg-stone-100 text-stone-800 p-3 rounded-2xl text-[13px] border border-stone-200/50 max-w-[85%] shadow-sm">${res.text}</div>`;
                        messages.appendChild(aBox);
                    } catch (e) {
                        lBox.innerHTML = `<div class="text-[10px] text-red-400">Connection error.</div>`;
                    }
                    messages.scrollTop = messages.scrollHeight;
                };

                document.getElementById('send-btn').onclick = handleSend;
                document.getElementById('chat-input').onkeydown = (e) => e.key === 'Enter' && handleSend();
                
                if (!ai) {
                    const info = document.createElement('div');
                    info.className = 'text-center p-8 text-[10px] text-stone-300 uppercase tracking-widest leading-relaxed';
                    info.innerText = "AI Offline: Key Not Configured";
                    document.getElementById('chat-messages').appendChild(info);
                }
            } catch (err) {
                console.warn("AI logic skipped:", err);
            }
        });
    </script>
</body>
</html>
